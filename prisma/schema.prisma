// Prisma schema for QuranMemorizer 2.0
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ===== Authentication Models (NextAuth) =====

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ===== User Model =====

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String?   @unique
  emailVerified   DateTime?
  image           String?
  hashedPassword  String?

  // Profile
  displayName     String?
  preferredLanguage String  @default("en")

  // Progress tracking
  streakCount     Int       @default(0)
  longestStreak   Int       @default(0)
  lastActiveAt    DateTime?
  totalTimeSpent  Int       @default(0) // in seconds

  // Settings stored as JSON
  settings        Json?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  accounts        Account[]
  sessions        Session[]
  recitationSessions RecitationSession[]
  goals           Goal[]
  badges          UserBadge[]
  bookmarks       Bookmark[]
  mistakes        Mistake[]
  streakHistory   StreakHistory[]
  fsrsCards       FSRSCard[]
  xpTransactions  XPTransaction[]
  leagueStandings LeagueStanding[]
  circleMembers   CircleMember[]
  challengeAttempts ChallengeAttempt[]
  gardenState     GardenState?
  pushSubscriptions PushSubscription[]

  @@index([email])
}

// ===== Quran Progress Models =====

model RecitationSession {
  id          String   @id @default(cuid())
  userId      String

  // What was practiced
  surahNumber Int
  startAyah   Int
  endAyah     Int
  pageNumber  Int?

  // Session details
  mode        SessionMode
  duration    Int       // seconds
  accuracy    Float?    // 0-100 percentage
  wordsRecited Int      @default(0)
  mistakeCount Int      @default(0)

  // Audio recording (optional)
  audioUrl    String?

  // Session lifecycle
  status        SessionStatus @default(COMPLETED)
  stateSnapshot Json?         // Full Zustand state for resume
  targetType    String?       // "mushaf" | "ayah" | "surah" | "juz" | "hizb" | "subject"
  pausedAt      DateTime?
  completedAt   DateTime?

  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mistakes    Mistake[]

  @@index([userId])
  @@index([userId, createdAt])
  @@index([userId, status])
  @@index([surahNumber])
}

enum SessionMode {
  READ
  MEMORIZE
  LISTEN
  REVIEW
}

enum SessionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  DISCARDED
}

model Mistake {
  id          String   @id @default(cuid())
  userId      String
  sessionId   String?

  // Location
  surahNumber Int
  ayahNumber  Int
  wordIndex   Int

  // Error details
  type        MistakeType
  recitedText String?
  correctText String
  severity    MistakeSeverity @default(MINOR)

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  session     RecitationSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, surahNumber])
  @@index([sessionId])
}

enum MistakeType {
  WRONG_WORD
  SKIPPED
  ADDED
  TASHKEEL
  ORDER
}

enum MistakeSeverity {
  MINOR
  MAJOR
}

// ===== Goals System =====

model Goal {
  id          String   @id @default(cuid())
  userId      String

  // Goal definition
  title       String
  type        GoalType

  // Target (stored as JSON for flexibility)
  // e.g., { surahNumber: 2, startAyah: 1, endAyah: 286 }
  // or { pages: [1, 2, 3, 4, 5] }
  target      Json

  // Tracking
  frequency   GoalFrequency
  progress    Int       @default(0) // percentage 0-100
  currentValue Int      @default(0)
  targetValue Int

  // Status
  isActive    Boolean   @default(true)
  completedAt DateTime?

  // Schedule
  reminderTime String?  // HH:mm format
  daysOfWeek   Int[]    // 0=Sun, 1=Mon, etc.

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isActive])
}

enum GoalType {
  MEMORIZE
  REVISE
  READ
  LISTEN
  AYAH_COUNT
  TIME_SPENT
}

enum GoalFrequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
  ONE_TIME
}

// ===== Gamification =====

model Badge {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "streak_7", "surah_complete_1"
  name        String
  description String
  icon        String   // Icon name or URL
  category    BadgeCategory
  requirement Json     // Requirements to earn this badge

  users       UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

enum BadgeCategory {
  STREAK
  MEMORIZATION
  CONSISTENCY
  MILESTONE
  SPECIAL
}

model StreakHistory {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime @db.Date
  isActive    Boolean  @default(true) // false if streak was broken

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([userId, date])
}

// ===== FSRS Spaced Repetition =====

model FSRSCard {
  id              String   @id @default(cuid())
  userId          String

  // Verse reference
  surahNumber     Int
  ayahNumber      Int

  // FSRS parameters
  due             DateTime @default(now())
  stability       Float    @default(0)
  difficulty      Float    @default(0)
  elapsedDays     Int      @default(0)
  scheduledDays   Int      @default(0)
  reps            Int      @default(0)
  lapses          Int      @default(0)
  state           Int      @default(0) // 0=New, 1=Learning, 2=Review, 3=Relearning
  lastReview      DateTime?

  // App tracking
  totalReviews    Int      @default(0)
  averageAccuracy Float    @default(0)
  category        String?  // sabaq, sabqi, manzil

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, surahNumber, ayahNumber])
  @@index([userId])
  @@index([userId, due])
  @@index([userId, state])
  @@index([userId, category])
}

// ===== XP & Gamification =====

model XPTransaction {
  id          String   @id @default(cuid())
  userId      String
  amount      Int
  source      String   // e.g., "session_complete", "streak_bonus", "badge_earned"
  sessionId   String?  // Optional link to session
  multiplier  Float    @default(1.0)

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

model LeagueStanding {
  id          String   @id @default(cuid())
  userId      String
  league      String   // talib, qari, hafiz, sheikh, imam
  weekKey     String   // e.g., "2026-W06"
  weeklyXP    Int      @default(0)
  rank        Int?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekKey])
  @@index([league, weekKey])
  @@index([userId])
}

// ===== Bookmarks & Notes =====

model Bookmark {
  id          String   @id @default(cuid())
  userId      String

  // Location
  surahNumber Int
  ayahNumber  Int
  pageNumber  Int?

  // Details
  title       String?
  note        String?  @db.Text
  color       String?  // Bookmark color for visual categorization

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, surahNumber])
}

// ===== User Settings (detailed type for reference) =====
// Settings are stored as JSON in User.settings
//
// interface UserSettings {
//   display: {
//     theme: 'light' | 'dark' | 'sepia' | 'system';
//     mushafEdition: string; // e.g., 'madinah_1421'
//     fontSize: number;
//     showTajweed: boolean;
//     showTranslation: boolean;
//     translationLanguage: string;
//     showTransliteration: boolean;
//   };
//   audio: {
//     preferredReciter: string;
//     playbackSpeed: number;
//     autoPlay: boolean;
//     repeatMode: 'none' | 'ayah' | 'surah';
//   };
//   memorization: {
//     revealMode: 'word' | 'phrase' | 'ayah';
//     mistakeSensitivity: 'strict' | 'normal' | 'lenient';
//     autoRecord: boolean;
//   };
//   notifications: {
//     dailyReminder: boolean;
//     reminderTime: string;
//     streakReminder: boolean;
//     goalReminder: boolean;
//   };
// }

// ===== Hifz Circles (Social) =====

model HifzCircle {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  isPublic    Boolean  @default(true)
  maxMembers  Int      @default(50)
  inviteCode  String   @unique @default(cuid())
  groupStreak Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     CircleMember[]
  challenges  CircleChallenge[]
  activities  CircleActivity[]

  @@index([isPublic])
}

model CircleMember {
  id           String     @id @default(cuid())
  userId       String
  circleId     String
  role         CircleRole @default(MEMBER)
  weeklyXP     Int        @default(0)
  joinedAt     DateTime   @default(now())
  lastActiveAt DateTime   @default(now())

  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  circle HifzCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@unique([userId, circleId])
  @@index([circleId])
  @@index([userId])
}

enum CircleRole {
  OWNER
  TEACHER
  MEMBER
}

model CircleChallenge {
  id          String   @id @default(cuid())
  circleId    String
  title       String
  description String?
  type        String   // "collective_recite", "accuracy", "streak"
  target      Json     // { surahNumber: 67, totalVerses: 30 }
  progress    Int      @default(0)
  isActive    Boolean  @default(true)
  startDate   DateTime @default(now())
  endDate     DateTime

  circle HifzCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@index([circleId, isActive])
}

model CircleActivity {
  id        String   @id @default(cuid())
  circleId  String
  userId    String
  type      String   // "session_complete", "badge_earned", "streak_milestone", "joined"
  data      Json?    // { surahNumber: 2, accuracy: 95, ... }
  createdAt DateTime @default(now())

  circle HifzCircle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@index([circleId, createdAt])
}

// ===== Similar Verse Pairs =====

model SimilarVersePair {
  id         String @id @default(cuid())
  verse1Key  String // "2:35"
  verse2Key  String // "7:19"
  similarity Float  // 0.0-1.0
  diffWords  Json   // words that differ
  category   String // "near_identical", "similar_opening", "similar_ending", "thematic"

  @@unique([verse1Key, verse2Key])
  @@index([verse1Key])
  @@index([verse2Key])
}

// ===== Challenges =====

model Challenge {
  id          String   @id @default(cuid())
  type        String   // "speed", "accuracy", "endurance", "random_verse", "daily"
  title       String
  description String?
  config      Json     // { surahNumber?, timeLimit?, accuracyThreshold?, verseCount? }
  xpReward    Int      @default(50)
  isDaily     Boolean  @default(false)
  activeDate  DateTime? @db.Date
  createdAt   DateTime @default(now())

  attempts    ChallengeAttempt[]
}

model ChallengeAttempt {
  id          String    @id @default(cuid())
  userId      String
  challengeId String
  score       Int
  accuracy    Float?
  duration    Int       // seconds
  completed   Boolean   @default(false)
  stars       Int       @default(0) // 1-3 stars
  createdAt   DateTime  @default(now())

  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, challengeId])
  @@index([userId, createdAt])
}

// ===== Garden State =====

model GardenState {
  id          String   @id @default(cuid())
  userId      String   @unique
  state       Json     // full GardenState object (surahTrees, rivers, biomes, decorations)
  hasanat     Int      @default(0)
  gardenLevel Int      @default(0)
  isParadise  Boolean  @default(false)
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ===== Push Subscriptions =====

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  keys      Json     // { p256dh, auth }
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ===== Quran Reference Data =====

model QuranSurah {
  number                 Int         @id          // 1-114, natural key
  name                   String                   // Arabic name with diacritics
  englishName            String
  englishNameTranslation String
  numberOfAyahs          Int
  revelationType         String                   // "Meccan" | "Medinan"
  startPage              Int                      // Madinah Mushaf start page
  ayahs                  QuranAyah[]

  @@index([englishName])
}

model QuranAyah {
  id              String     @id @default(cuid())
  number          Int                              // Global (1-6236)
  numberInSurah   Int
  surahNumber     Int
  text            String     @db.Text              // Uthmani script
  textSimple      String     @db.Text              // No diacritics
  juz             Int
  hizb            Int
  hizbQuarter     Int
  page            Int                              // Madinah Mushaf page
  sajda           Json?
  surah           QuranSurah @relation(fields: [surahNumber], references: [number])

  @@unique([surahNumber, numberInSurah])
  @@index([surahNumber])
  @@index([page])
  @@index([juz])
  @@index([number])
}

model QuranPageLayout {
  id              Int        @id                   // Page number (1-604)
  edition         String     @default("madinah_1421")
  layout          Json                             // Full MushafPage JSON
  surahsOnPage    Int[]
  juz             Int
  hizb            Int

  @@unique([id, edition])
  @@index([edition])
}

model QuranJuz {
  number          Int        @id                   // 1-30
  name            String
  nameArabic      String
  startSurah      Int
  startAyah       Int
  startPage       Int
}

model QuranReciter {
  id              String     @id                   // e.g., "ar.alafasy"
  name            String
  englishName     String
  arabicName      String
  style           String?
  bitrate         Int?
  baseUrl         String
}

model QuranWord {
  id              Int      @id @default(autoincrement())
  surahNumber     Int
  ayahNumber      Int
  position        Int                              // 1-indexed in ayah
  textUthmani     String
  textIndopak     String?
  textSimple      String                           // No diacritics
  transliteration String?
  translation     String?                          // Word-by-word English
  charType        String   @default("word")        // "word" | "end" | "pause"
  wordKey         String   @unique                 // "2:255:3"
  audioUrl        String?

  @@index([surahNumber, ayahNumber])
  @@index([surahNumber])
}

model TranslationEdition {
  identifier    String  @id                // "en.sahih"
  name          String
  englishName   String
  language      String                     // "en", "ar", "ur"
  direction     String  @default("ltr")
  author        String?
  isPopular     Boolean @default(false)
  translations  QuranTranslation[]

  @@index([language])
}

model QuranTranslation {
  id            Int      @id @default(autoincrement())
  editionId     String
  surahNumber   Int
  ayahNumber    Int
  text          String   @db.Text

  edition       TranslationEdition @relation(fields: [editionId], references: [identifier])

  @@unique([editionId, surahNumber, ayahNumber])
  @@index([editionId, surahNumber])
  @@index([surahNumber, ayahNumber])
}
