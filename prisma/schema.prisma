// Prisma schema for QuranMemorizer 2.0
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ===== Authentication Models (NextAuth) =====

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ===== User Model =====

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String?   @unique
  emailVerified   DateTime?
  image           String?
  hashedPassword  String?

  // Profile
  displayName     String?
  preferredLanguage String  @default("en")

  // Progress tracking
  streakCount     Int       @default(0)
  longestStreak   Int       @default(0)
  lastActiveAt    DateTime?
  totalTimeSpent  Int       @default(0) // in seconds

  // Settings stored as JSON
  settings        Json?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  accounts        Account[]
  sessions        Session[]
  recitationSessions RecitationSession[]
  goals           Goal[]
  badges          UserBadge[]
  bookmarks       Bookmark[]
  mistakes        Mistake[]
  streakHistory   StreakHistory[]
  fsrsCards       FSRSCard[]
  xpTransactions  XPTransaction[]
  leagueStandings LeagueStanding[]

  @@index([email])
}

// ===== Quran Progress Models =====

model RecitationSession {
  id          String   @id @default(cuid())
  userId      String

  // What was practiced
  surahNumber Int
  startAyah   Int
  endAyah     Int
  pageNumber  Int?

  // Session details
  mode        SessionMode
  duration    Int       // seconds
  accuracy    Float?    // 0-100 percentage
  wordsRecited Int      @default(0)
  mistakeCount Int      @default(0)

  // Audio recording (optional)
  audioUrl    String?

  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mistakes    Mistake[]

  @@index([userId])
  @@index([userId, createdAt])
  @@index([surahNumber])
}

enum SessionMode {
  READ
  MEMORIZE
  LISTEN
  REVIEW
}

model Mistake {
  id          String   @id @default(cuid())
  userId      String
  sessionId   String?

  // Location
  surahNumber Int
  ayahNumber  Int
  wordIndex   Int

  // Error details
  type        MistakeType
  recitedText String?
  correctText String
  severity    MistakeSeverity @default(MINOR)

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  session     RecitationSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, surahNumber])
  @@index([sessionId])
}

enum MistakeType {
  WRONG_WORD
  SKIPPED
  ADDED
  TASHKEEL
  ORDER
}

enum MistakeSeverity {
  MINOR
  MAJOR
}

// ===== Goals System =====

model Goal {
  id          String   @id @default(cuid())
  userId      String

  // Goal definition
  title       String
  type        GoalType

  // Target (stored as JSON for flexibility)
  // e.g., { surahNumber: 2, startAyah: 1, endAyah: 286 }
  // or { pages: [1, 2, 3, 4, 5] }
  target      Json

  // Tracking
  frequency   GoalFrequency
  progress    Int       @default(0) // percentage 0-100
  currentValue Int      @default(0)
  targetValue Int

  // Status
  isActive    Boolean   @default(true)
  completedAt DateTime?

  // Schedule
  reminderTime String?  // HH:mm format
  daysOfWeek   Int[]    // 0=Sun, 1=Mon, etc.

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isActive])
}

enum GoalType {
  MEMORIZE
  REVISE
  READ
  LISTEN
  AYAH_COUNT
  TIME_SPENT
}

enum GoalFrequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
  ONE_TIME
}

// ===== Gamification =====

model Badge {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "streak_7", "surah_complete_1"
  name        String
  description String
  icon        String   // Icon name or URL
  category    BadgeCategory
  requirement Json     // Requirements to earn this badge

  users       UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

enum BadgeCategory {
  STREAK
  MEMORIZATION
  CONSISTENCY
  MILESTONE
  SPECIAL
}

model StreakHistory {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime @db.Date
  isActive    Boolean  @default(true) // false if streak was broken

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([userId, date])
}

// ===== FSRS Spaced Repetition =====

model FSRSCard {
  id              String   @id @default(cuid())
  userId          String

  // Verse reference
  surahNumber     Int
  ayahNumber      Int

  // FSRS parameters
  due             DateTime @default(now())
  stability       Float    @default(0)
  difficulty      Float    @default(0)
  elapsedDays     Int      @default(0)
  scheduledDays   Int      @default(0)
  reps            Int      @default(0)
  lapses          Int      @default(0)
  state           Int      @default(0) // 0=New, 1=Learning, 2=Review, 3=Relearning
  lastReview      DateTime?

  // App tracking
  totalReviews    Int      @default(0)
  averageAccuracy Float    @default(0)
  category        String?  // sabaq, sabqi, manzil

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, surahNumber, ayahNumber])
  @@index([userId])
  @@index([userId, due])
  @@index([userId, state])
  @@index([userId, category])
}

// ===== XP & Gamification =====

model XPTransaction {
  id          String   @id @default(cuid())
  userId      String
  amount      Int
  source      String   // e.g., "session_complete", "streak_bonus", "badge_earned"
  sessionId   String?  // Optional link to session
  multiplier  Float    @default(1.0)

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

model LeagueStanding {
  id          String   @id @default(cuid())
  userId      String
  league      String   // talib, qari, hafiz, sheikh, imam
  weekKey     String   // e.g., "2026-W06"
  weeklyXP    Int      @default(0)
  rank        Int?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekKey])
  @@index([league, weekKey])
  @@index([userId])
}

// ===== Bookmarks & Notes =====

model Bookmark {
  id          String   @id @default(cuid())
  userId      String

  // Location
  surahNumber Int
  ayahNumber  Int
  pageNumber  Int?

  // Details
  title       String?
  note        String?  @db.Text
  color       String?  // Bookmark color for visual categorization

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, surahNumber])
}

// ===== User Settings (detailed type for reference) =====
// Settings are stored as JSON in User.settings
//
// interface UserSettings {
//   display: {
//     theme: 'light' | 'dark' | 'sepia' | 'system';
//     mushafEdition: string; // e.g., 'madinah_1421'
//     fontSize: number;
//     showTajweed: boolean;
//     showTranslation: boolean;
//     translationLanguage: string;
//     showTransliteration: boolean;
//   };
//   audio: {
//     preferredReciter: string;
//     playbackSpeed: number;
//     autoPlay: boolean;
//     repeatMode: 'none' | 'ayah' | 'surah';
//   };
//   memorization: {
//     revealMode: 'word' | 'phrase' | 'ayah';
//     mistakeSensitivity: 'strict' | 'normal' | 'lenient';
//     autoRecord: boolean;
//   };
//   notifications: {
//     dailyReminder: boolean;
//     reminderTime: string;
//     streakReminder: boolean;
//     goalReminder: boolean;
//   };
// }
